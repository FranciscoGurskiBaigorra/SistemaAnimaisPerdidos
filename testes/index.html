<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Mapa de Animais - OpenStreetMap</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  #map {
    height: 600px;
    width: 100%;
  }

  .popup-form {
    font-size: 14px;
  }

  .popup-form input, .popup-form select, .popup-form textarea {
    width: 100%;
    margin-bottom: 8px;
  }
</style>
</head>
<body>

<h2>üêæ Mapa de Animais Perdidos / Encontrados</h2>
<p>Clique no mapa para cadastrar um novo animal.</p>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Inicializa o mapa
var map = L.map('map').setView([-29.78126, -57.10689], 13);

// Camada de mapa do OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
}).addTo(map);

// Fun√ß√£o para carregar pontos do banco
function carregarPontos() {
    fetch('carregar_pontos.php')
        .then(response => response.json())
        .then(data => {
            data.forEach(animal => {
                L.marker([animal.latitude, animal.longitude])
                .addTo(map)
                .bindPopup(`
                    <b>üêæ ${animal.nome}</b><br>
                    <b>Esp√©cie:</b> ${animal.especie}<br>
                    <b>Situa√ß√£o:</b> ${animal.situacao}<br>
                    <b>Descri√ß√£o:</b> ${animal.descricao || 'Sem descri√ß√£o'}<br>
                    <b>Registrado em:</b> ${animal.data_registro}
                `);
            });
        });
}

// Evento de clique no mapa
map.on('click', function(e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;

    // Cria um formul√°rio dentro do popup
    var popupContent = `
        <div class="popup-form">
            <h4>Cadastro do Animal</h4>
            <label>Nome:</label><input type="text" id="nome" required><br>
            <label>Esp√©cie:</label>
            <select id="especie">
                <option value="cachorro">Cachorro</option>
                <option value="gato">Gato</option>
                <option value="outro">Outro</option>
            </select><br>
            <label>Situa√ß√£o:</label>
            <select id="situacao">
                <option value="perdido">Perdido</option>
                <option value="encontrado">Encontrado</option>
            </select><br>
            <label>Descri√ß√£o:</label><textarea id="descricao" rows="3"></textarea><br>
            <button onclick="salvarAnimal(${lat}, ${lng})">Salvar</button>
        </div>
    `;

    L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(map);
});

// Fun√ß√£o para salvar no banco
function salvarAnimal(lat, lng) {
    const nome = document.getElementById('nome').value;
    const especie = document.getElementById('especie').value;
    const situacao = document.getElementById('situacao').value;
    const descricao = document.getElementById('descricao').value;

    if (!nome) {
        alert('Por favor, preencha o nome do animal.');
        return;
    }

    fetch('salvar_local.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `nome=${encodeURIComponent(nome)}&especie=${encodeURIComponent(especie)}&situacao=${encodeURIComponent(situacao)}&descricao=${encodeURIComponent(descricao)}&lat=${lat}&lng=${lng}`
    })
    .then(response => response.text())
    .then(data => {
        alert(data);
        map.closePopup();
        map.eachLayer((layer) => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
        });
        carregarPontos(); // recarrega todos os marcadores
    })
    .catch(err => alert("Erro: " + err));
}

// Carrega pontos ao iniciar
carregarPontos();
</script>

</body>
</html>